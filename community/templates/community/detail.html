{% extends 'base.html' %}
{% load bootstrap4 %}

{% block content %}
  <div class="container border-0 bg-white mb-3" style="border-radius: 2rem;">
    <div class="row my-3 fs-1 fw-bold p-3">{{ review.title }}</div>
    <div class="row bg-light px-1">
      <div class="col my-auto">
        {% if request.user == review.user %}
          <a href="{% url 'accounts:profile' review.user.username %}" class="text-dark text-decoration-none fw-bold">
            {{ review.user }} (나)
          </a>
        {% else %}
          <a href="{% url 'accounts:profile' review.user.username %}" class="text-dark text-decoration-none fw-bold">
            {{ review.user }}
          </a>
        {% endif %}
      </div>
      <div class="col my-auto">{{ review.movie }}</div>
      <div class="col my-auto text-end">{{ review.created_at | date:'Y.m.d H:i'}}</div>
      <div class="col-1">
        <form id="like-form" data-review-id="{{ review.pk }}">
          {% csrf_token %}
          {% if user in review.like_users.all %}
            <button class="btn btn-link text-danger"><i class="fas fa-heart"></i></button>
          {% else %}
            <button class="btn btn-link text-secondary"><i class="fas fa-heart"></i></button>
          {% endif %}
        </form>
      </div>
      <div id="like-cnt" class="col-1 my-auto">{{ review.like_users.all | length }}</div>
    </div>
    <div class="row mx-2 my-5" style="width:100%">{{ review.content }}</div>
    {% if user == review.user %}
      <div class="row justify-content-between my-3">
        <div class="col-2">
          <a class="btn btn-primary w-100" href="{% url 'community:update' review.pk %}">UPDATE</a>
        </div>
        <div class="col-2">
          <form action="{% url 'community:delete' review.pk %}" method="POST">
            {% csrf_token %}
            <input class="btn btn-danger w-100 px-auto"type="submit" value="DELETE">
          </form>
        </div>
      </div>
    {% endif %}
    <div class="row p-3 bg-light">
      댓글 {{ comments|length }}
    </div>
    <div class="row p-3">
      <form action="{% url 'community:create_comment' review.pk%}" method="POST" class="m-1">
        {% csrf_token %}
        {% bootstrap_form comment_form %}
        <input class="btn btn-dark my-3" type="submit" value="작성">
      </form>
    </div>
    {% for comment in comments %}
      <div class="row px-2">
        {% if request.user == comment.user %}
          <a href="{% url 'accounts:profile' comment.user.username %}" class="col-2 text-dark text-decoration-none fw-bold my-auto">{{ comment.user }} (나)</a>
        {% elif review.user == comment.user %}
          <a href="{% url 'accounts:profile' comment.user.username %}" class="col-2 text-dark text-decoration-none fw-bold my-auto">{{ comment.user }} (글쓴이)</a>
        {% else %}
          <a href="{% url 'accounts:profile' comment.user.username %}" class="col-2 text-dark text-decoration-none fw-bold my-auto">{{ comment.user }}</a>
        {% endif %}
        {% if user == comment.user %}
          <div class="col-4 my-3">
            <a href="{% url 'community:update_comment' review.pk comment.pk %}" class="text-dark text-decoration-none fw-bold">{{ comment.content }}</a>
          </div>
          <div class="col-2 m-auto">
            <form action="{% url 'community:delete_comment' review.pk comment.pk %}" method="POST" class="d-inline">
              {% csrf_token %}
              <input class="btn btn-link w-100 text-decoration-none text-danger" type="submit" value="삭제">
            </form>
          </div>
        {% else %}
          <div class="col-6 my-3">{{ comment.content }}</div>
        {% endif %}
        {% if comment.created_string %}
          <div class="col-2 my-auto text-center">{{ comment.created_string }}</div>
        {% else %}
          <div class="col-2 my-auto text-center">{{ comment.created_at | date:'y.m.d' }}</div>
        {% endif %}
        {% if comment.updated_string %}
          <div class="col-2 my-auto text-center">{{ comment.updated_string }}</div>
        {% else %}
          <div class="col-2 my-auto text-center">{{ comment.updated_at | date:'y.m.d' }}</div>
        {% endif %}
      </div>
    {% endfor %}
    <hr>
  </div>
  <script>
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value
    const likeForm = document.querySelector('#like-form')

    likeForm.addEventListener('submit', event => {
      const reviewId = event.target.dataset.reviewId
      event.preventDefault()
      axios({
        method: 'post',
        url: `/community/${reviewId}/like/`,
        headers: {'X-CSRFToken': csrftoken},
      })
      .then(response => {
        const {isLiked, likes} = response.data
        const likeBtn = document.querySelector("#like-form > button")
        const likeCnt = document.querySelector("#like-cnt")
        if (isLiked) {
          likeBtn.className = "btn btn-link text-danger"
        } else {
          likeBtn.className = "btn btn-link text-secondary"
        }
        likeCnt.innerText = `${likes}`
      })
    })
  </script>
{% endblock  %}
